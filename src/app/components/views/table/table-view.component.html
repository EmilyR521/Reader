<div class="table-view-container">
  <app-filter-controls
    [books]="books"
    mode="table"
    (filtersChanged)="onFiltersChanged($event)"
    #filterControls>
  </app-filter-controls>
  <div class="table-wrapper">
    <table class="books-table">
      <thead>
        <tr>
          <th class="sortable" (click)="sortBy('title')">
            <span class="header-content">
              <span>Title</span>
              <span class="sort-icon">{{ getSortIcon('title') }}</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('title', $event)" title="Filter by title">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
          <th class="sortable" (click)="sortBy('author')">
            <span class="header-content">
              <span>Author</span>
              <span class="sort-icon">{{ getSortIcon('author') }}</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('author', $event)" title="Filter by author">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
          <th class="sortable" (click)="sortBy('status')">
            <span class="header-content">
              <span>Status</span>
              <span class="sort-icon">{{ getSortIcon('status') }}</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('status', $event)" title="Filter by status">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
          <th class="sortable" (click)="sortBy('readingStartDate')">
            <span class="header-content">
              <span>Started</span>
              <span class="sort-icon">{{ getSortIcon('readingStartDate') }}</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('dateRangeStart', $event)" title="Filter by start date">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
          <th class="sortable" (click)="sortBy('readingEndDate')">
            <span class="header-content">
              <span>Finished</span>
              <span class="sort-icon">{{ getSortIcon('readingEndDate') }}</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('dateRangeEnd', $event)" title="Filter by end date">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
          <th class="sortable" (click)="sortBy('rating')">
            <span class="header-content">
              <span>Rating</span>
              <span class="sort-icon">{{ getSortIcon('rating') }}</span>
            </span>
          </th>
          <th>
            <span class="header-content">
              <span>Tags</span>
            </span>
            <button class="filter-icon-btn" (click)="openFilterForField('tags', $event)" title="Filter by tags">
              <span class="filter-icon">üîç</span>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let book of sortedBooks" [class]="'status-' + book.status" (contextmenu)="onRowRightClick($event, book)">
          <td class="title-cell clickable-title" (click)="onViewBook(book)">{{ book.title }}</td>
          <td class="clickable-author" (click)="filterControls.filterByAuthor(book.author, $event)" [title]="'Click to filter by ' + book.author">{{ book.author }}</td>
          <td class="clickable-status" (click)="filterControls.filterByStatus(book.status, $event)" [title]="'Click to filter by ' + book.status">
            <span class="status-badge" [class]="'status-' + book.status">{{ book.status }}</span>
          </td>
          <td class="date-cell">
            {{ book.readingStartDate ? (book.readingStartDate | date:'shortDate') : '‚Äî' }}
          </td>
          <td class="date-cell">
            {{ book.readingEndDate ? (book.readingEndDate | date:'shortDate') : '‚Äî' }}
          </td>
          <td class="rating-cell">
            <span *ngIf="book.rating && book.rating !== BookRating.None" class="rating-icon-display" [class]="'rating-' + book.rating" [title]="getRatingLabel(book.rating)">
              <span *ngIf="book.rating === BookRating.Positive">üëç</span>
              <span *ngIf="book.rating === BookRating.Negative">üëé</span>
              <span *ngIf="book.rating === BookRating.Favourite">‚ù§Ô∏è</span>
            </span>
            <span *ngIf="!book.rating || book.rating === BookRating.None" class="empty">‚Äî</span>
          </td>
          <td class="tags-cell" [class.empty-tags]="!book.tags || book.tags.length === 0" (click)="onTagsCellClick($event, book)">
            <span 
              *ngFor="let tag of book.tags" 
              class="tag clickable-tag"
              (click)="filterControls.filterByTag(tag, $event); $event.stopPropagation()"
              [title]="'Click to filter by ' + tag">
              {{ tag }}
            </span>
            <span *ngIf="!book.tags || book.tags.length === 0" class="empty" [title]="'Click to add tags'">‚Äî</span>
          </td>
        </tr>
        <tr *ngIf="sortedBooks.length === 0" class="empty-row">
          <td colspan="7" class="empty-message">
            {{ activeFilters.length > 0 ? 'No books match the selected filters' : 'No books in your reading list' }}
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="table-footer">
          <td colspan="7">
            <div class="footer-content">
              <div class="footer-left">
                <span class="row-count">{{ sortedBooks.length }} {{ sortedBooks.length === 1 ? 'book' : 'books' }}</span>
                <span *ngIf="hasActiveFilters()" class="filter-indicator">
                  (filtered from {{ books.length }} total)
                </span>
              </div>
              <div class="footer-right" *ngIf="hasActiveFilters() && sortedBooks.length > 0">
                <div class="footer-collection-menu-wrapper">
                  <button 
                    class="btn btn-primary btn-small footer-add-collection-btn"
                    (click)="toggleFooterCollectionMenu()"
                    [class.active]="showFooterCollectionMenu"
                    [disabled]="isAddingToCollection">
                    <span *ngIf="!isAddingToCollection">+ Add {{ sortedBooks.length }} {{ sortedBooks.length === 1 ? 'Book' : 'Books' }} to Collection</span>
                    <span *ngIf="isAddingToCollection">Adding...</span>
                  </button>
                  <div class="footer-collection-dropdown" *ngIf="showFooterCollectionMenu && getFooterAvailableCollections().length > 0">
                    <div 
                      *ngFor="let collection of getFooterAvailableCollections()"
                      class="footer-collection-dropdown-item"
                      (click)="addAllFilteredBooksToCollection(collection.id)">
                      {{ collection.name }}
                    </div>
                  </div>
                  <div *ngIf="showFooterCollectionMenu && getFooterAvailableCollections().length === 0" class="footer-collection-dropdown empty">
                    <div class="footer-collection-dropdown-item disabled">No collections available</div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Context Menu -->
  <div 
    class="context-menu" 
    *ngIf="contextMenuVisible"
    [style.left.px]="contextMenuX"
    [style.top.px]="contextMenuY"
    (click)="$event.stopPropagation()">
    <div 
      class="context-menu-item" 
      [class.submenu-left-item]="submenuOnLeft"
      *ngIf="getAvailableCollections().length > 0"
      (mouseenter)="submenuVisible = true"
      (mouseleave)="submenuVisible = false">
      <div class="context-menu-label">Add to collection</div>
      <div 
        class="context-menu-submenu" 
        [class.submenu-left]="submenuOnLeft"
        [class.submenu-visible]="submenuVisible"
        (mouseenter)="submenuVisible = true"
        (mouseleave)="submenuVisible = false">
        <div 
          *ngFor="let collection of getAvailableCollections()"
          class="context-menu-subitem"
          (click)="addToCollection(collection.id)">
          {{ collection.name }}
        </div>
      </div>
    </div>
    <div class="context-menu-item context-menu-item-disabled" *ngIf="getAvailableCollections().length === 0">
      <div class="context-menu-label">No available collections</div>
    </div>
    <div 
      class="context-menu-item"
      *ngIf="selectedBook"
      (click)="findOnWoB(selectedBook)">
      <div class="context-menu-label">Find on WoB</div>
    </div>
  </div>

  <!-- Tag Dropdown -->
  <div 
    class="tag-dropdown" 
    *ngIf="tagDropdownVisible && tagDropdownBook"
    [style.left.px]="tagDropdownX"
    [style.top.px]="tagDropdownY"
    (click)="$event.stopPropagation()">
    <div class="tag-dropdown-header">
      <span class="tag-dropdown-title">Add Tag</span>
      <button class="tag-dropdown-close" (click)="closeTagDropdown()" title="Close">‚úï</button>
    </div>
    <div class="tag-dropdown-content">
      <div 
        *ngIf="getAvailableTagsForBook(tagDropdownBook!).length === 0" 
        class="tag-dropdown-empty">
        No tags available. Tags will appear here as you add them to books.
      </div>
      <div 
        *ngFor="let tag of getAvailableTagsForBook(tagDropdownBook!)"
        class="tag-dropdown-item"
        (click)="addTagToBook(tag)">
        {{ tag }}
      </div>
    </div>
  </div>
</div>
